% shall we have a discussion section after methods and results?
% Discussion
% 	- possibility of using the "domination graph" as data,
% 	where decks are nodes and win rates are the directed
% 	edges
% 	- there is some correlation in the win rate dictionary
% 	distribution, as cards appear alongside other cards
% 	- we don't use a Hessian or Jacobian based opt method,
% 	which would have been useful to understand sensitivity

To achieve the goals outlined in the introduction, we built an auto-battler game with we a number of special cards with extra mechanics, as well as a basic `vanilla' card that only engages in standard combat and has no extra mechanics. The details of these cards and their mechanics are explained below in Section~\ref{sec:ab-game-def}. The health and attack values of all cards can be adjusted, as well as some values pertaining to the extra mechanics (such as how much damage to deal to an opponent when a card dies). Multiple cards of the same type, but with different attack, health, or other values can be put into consideration in the same game. 

Beyond the auto-battler itself, we also constructed an optimization framework to find configurations of available cards which are balanced, fair, and fun. These criteria are obviously quite subjective, so new metrics are easily pluggable into the existing framework, as game designers develop new ways of capturing their goals and preferences about the metagame. A few options are explored within this paper as well.

\subsection{Playtesting simulator} \label{sec:sim}

To serve as a data source for quantitative analysis, we create
a playtesting simulator of an auto battler game. 
This simulator is designed for research. It allows the user to 
create cards with new mechanics and run tournaments between
arbitrary decks. 

All cards are equally available to all players, and there are no restrictions on the number of copies of a card allowed in players' decks or in the entire game. Some auto-battlers have a drafting process in which cards are selected or purchased from a pool, but drafting and/or deck-building take different forms across different games \cite{hearthstone-battlegrounds,storybook-brawl,feh-pawnsOfLoki-video}. We do not explore variants of these processes in this paper, but may consider them in future work.

\subsubsection{Game definition} \label{sec:ab-game-def}

Cards have nonnegative integer statistics including health points, 
attack, and parameters pertaining to a special mechanism. Such special parameters
developed include the following:

% consider table instead of bullets for space
\begin{itemize}
	\item Explosion damage. When the card dies, it damages
	each of the opponent's cards by this many health points.
	\item Heal amount. Prior to entering combat, the card 
	restores this many health points to its player's rightmost
	card
	\item Attack growth per hit. When the card takes damage, its
	attack increases by this many points.
	\item Explosion heal. When the card dies, it heals
	each of its player's other cards by this many health points.
	\item Heal donation percent. When the card would be healed,
	it instead restores this many percent of the health points
	to itself and donates the remaining health points to its
	player's other cards evenly.
	\item Armor points. The card starts with this many armor points.
	When the card would be damaged, it instead loses an armor point.
	When the card has zero armor points, it may be damaged normally.
	\item Damage split percent. When the card would be damaged,
	it instead receives this many percent of the damage to itself
	and splits the remaining damage evenly to its player's other cards.
	\item Middle age. Prior to entering combat, the card increases its
	attack by 1 if it has not participated in this many combat phases.
	After this many combat phases, the card decreases its attack by 1
	before entering combat.
	\item Target age. When the card dies, if it participated in this many
	combat phases, deal this many damage points to each of the opponent's
	cards. If the card participated in fewer than this many combat phases, 
	heal each of its player's other cards by health points equal to the
	number of combat phases in which the card participated.
	\item Detonation time. When the card has been healed or damaged this
	many times, the card and its opponent both die.
\end{itemize}

Other card mechanics without parameters include the ability to copy the 
attack of the opponent's cards (morphing enemies) and the ability to swap 
its health points and attack whenever its attack is greater than its health 
points (survivalist).

\subsubsection{Match procedure} \label{sec:game}

For the simulator, gameplay proceeds as follows:

\begin{enumerate}
	\item Each player in a tournament selects an ordered list
	of cards to be their deck.
	\item Prior to combat, the deck is arranged left-to-right.
	\item Each combat phase pits the leftmost surviving card
	of each player against each other. The cards take damage by 
	reducing their health points by their opponent card's attack.
	Cards with zero or fewer health points are dead. Surviving cards
	are arranged to be the rightmost card of their respective decks.
	\item Repeat combat until one or fewer players has a surviving card
	or the maximum number of combat phases allowed has been reached.
	If both or neither players have at least one surviving card, the game is a tie.
	Otherwise, the player with a surviving card wins.
\end{enumerate}

\subsubsection{Win rate approximation} \label{sec:tourney}

We run a round-robin tournament where each deck plays one match against every other deck.
Unfortunately, for $n$ decks, this results in $n(n-1)/2 = n^2/2 - n/2$ matches. This quickly becomes prohibitively large to simulate. We developed an approximation algorithm that runs a subset of the games in order to estimate the win rates of cards and decks. It
randomly partitions the decks into groups of uniform size and runs round-robin tournaments within these groups.
For a group tournament with $k$ groups and $n$ total decks, this results in an upper bound of $k(n/k)(n/k - 1)/2 = n^2/(2k) - n/2$ matches in the case where 
$n$ is divisible by $k$.

\subsection{Metrics} \label{sec:metrics}

Quantitative measures of metagame health are needed to guide 
card statistic optimization. We present metrics built upon the
output data of the playtesting simulator.

The playtesting simulation outputs a data vector $v$.
Each entry $v_i \in [-1, 1]$ represents the average payoff of
the deck at index $i$ during the last round of playtesting in
the optimization process. A payoff of 1 indicates a win. A
payoff of 0 means a tie, and a loss results in a payoff of -1.
The average of these payoffs over the course of the simulated
tournament for a deck make up the entries of $v$.

We then transform $v$ into another vector of length $n$ which maps a card to the
average win rate of the decks in which the card appears. This
vector $w$ has entries
$w_j \in [0, 1]$, the average win rate of the decks in which
the card at index $j$ appears. We present three metrics that 
use this distribution of win rates among the cards.

\subsubsection{Per-card payoff}

\begin{equation}
	\mathrm{PCP} = \frac{1}{n} \sum_j \left|\mathrm{payoff}(w_j)\right|^2
\end{equation}

Since average payoffs are equal to 0 when a deck when it wins as many matches as it loses, this is a metric to 
minimize if we want to punish very competitive or terrible decks.

\subsubsection{Standard deviation metric}

\begin{equation}
	\mathrm{SDM} = \sqrt{\frac{1}{n} \sum_j \left|w_j - \left(\frac{1}{n}\sum_j w_j\right)\right|^2}
\end{equation}

Standard deviation of the win rates is a metric we may seek to minimize. Doing so may avoid cards with
very high or low win rates compared to others.

\subsubsection{Entropy metric}

\begin{equation}
	\mathrm{EM} = -\sum_j \frac{w_j}{\sum_j w_j} \log\left(\frac{w_j}{\sum_j w_j}\right)
\end{equation}

Entropy of the win rates is a metric we may seek to maximize. When entropy is maximized, we approach a uniform
distribution of cards over win rates.

\subsubsection{Other metrics} \label{sec:othermetrics}

Our framework is flexible; researchers and designers alike may develop their own metrics corresponding to their
own ideas of what constitutes a healthy metagame. For example, a game designer may know from historical data that
a certain distribution of cards or decks over win rates corresponded to a period of celebrated parity in the metagame. 
The designer could conceivably use the Wasserstein distance or Kullback--Leibler 
divergence between this historical distribution and another distribution as a metric. Minimizing this metric 
might maintain similar levels of parity through future iterations of card releases.

\subsection{Optimization} \label{sec:optimization}

We use the PyGAD python library \cite{gad2021pygad} for genetic optimization algorithms. This searches for the optimal values of
parameters, which may include health points, attack, and special parameters, that optimizes
the chosen metric.

We constrain the genetic algorithm to consider integer values between 1 and 10, inclusive. While hyperparameter tuning may have yielded better results,
we chose to run the genetic algorithm with 8 solutions and 4 parents mating per population for 32 generations in each experiment.

\subsection{Qualitative analysis}

Another way to understand the landscape of the metagame is through more qualitative methods. We look at two different ways of plotting data about the game results which give insights into the health and stability of the metagame. 

The first plot is a sweep over two variables, typically of the same card, although not necessarily. This gives a visual representation of the metagame throughout various configurations, and can lead to some interesting insights about the relationship between cards.

\begin{figure}[t]
	\includegraphics[width=10cm, height=8cm]{bruiser_vs_grow} 
	\caption{Plot of standard deviation metric for various values of the attack of a card with no special parameters fixed at 1 health point (bruiser) and the health points of a card with attack growth per hit and initial attack fixed at 1 (grow on damage).}
	\label{fig:bruiser_vs_grow}
\end{figure}

Take, for example, the plot in Figure~\ref{fig:bruiser_vs_grow}, of the value of the standard deviation metric given various values for the attack of the bruiser card and the health of the grow on damage card. The bruiser card is a vanilla card with a high attack (although variable in this situation) and one health point. The grow on damage card has a mechanic where each time it takes damage it gains one attack. Initially this card has no attack, and in this situation has a variable amount of health. If the grow on damage card is able to consistently become a powerful threat, it can become too strong, and a necessity for high level play, leading to an unbalanced metagame.

In the figure we can see that configurations in the upper left corner, where the attack of the bruiser is greater than the health of the grow on damage card, tend to be much more favorable than the configurations in the lower right corner, where the opposite is true. This evidence supports the intuitive idea that the bruiser's high attack is a good counter to the grow on damage card, because it can quickly remove the monster before it has had enough interactions to grow its damage to a large number. This kind of information can be quite useful to a game designer, who can see very clearly that the inclusion of a high damage card can improve the metagame dramatically if the grow on damage card is found to be too powerful.

The second plot explored is a histogram of the deck win rates. After running a tournament amongst all possible decks, the win rates of each deck are plotted in a histogram. The resulting distribution can have features which may be useful to human game designers. For example, examine the difference between the distributions shown in Figure~\ref{fig:special_only_dist}. 

% TODO: Continue generating more distribution plots, and with other metrics perhaps. And metric discrepancy between logs and pickle file. Investigate length of games.
\begin{figure}[t]
	\includegraphics[scale=0.5]{special_only_4_5_8_8_4_8_3_3_3_5}
	\includegraphics[scale=0.5]{special_only_1_3_4_3_3_1_7_8_5_7}
	\caption{Two different distribution of deck win rates.}
	\label{fig:special_only_dist}
\end{figure}

Given playtesting input from actual players and historical data from other successful metagames, game designers can understand the what changes new cards have brought and implement changes to the game or metrics for optimization which will improve the experience of human players.

\subsection{Experiment design}

% in methods: only describe the phases of experiments in a high level -- 1. build decks 2. tournaments 3. ... their common pattern
% describe set up, techniques; write about analysis and numbers in results

Our experiments share common phases.

\begin{enumerate}
	\item Build decks. We generate a set of cards and their associated attack, health points, and special parameters.
	Depending on the experiment, some or all of these variables may be varied from simulation to simulation during the optimization process.
	From this set of cards, the decks are permutations of 3 cards from the set, allowing for duplicates.
	\item Run tournaments. This will be either be a group or a round-robin tournament as described in Section~\ref{sec:tourney}.
	\item Optimize. These tournaments are run within each iteration of our genetic algorithm to produce a metric estimating the best
	possible health of the metagame with respect to parameters of the built decks.
\end{enumerate}
